<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClashWeb é¢æ¿</title>
    <link rel="icon" href="/images/favicon.ico">
    
    <script src="/lib/tailwindcss.js"></script>
    <script src="/lib/vue.global.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { primary: '#6366f1', action: '#16a34a' } } }
        }
    </script>
    <style>
        body { transition: background-color 0.3s; }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .modal-mask { z-index: 9999; }
        .card-selected { border-color: #ef4444 !important; background-color: rgba(239, 68, 68, 0.1) !important; }
        .region-card { @apply bg-white dark:bg-gray-800 p-3 rounded-lg border border-gray-100 dark:border-gray-700 flex items-center justify-between shadow-sm hover:shadow-md transition relative overflow-hidden; }
        .region-flag-bg { position: absolute; right: -10px; bottom: -15px; font-size: 5rem; opacity: 0.15; filter: grayscale(20%); z-index: 0; pointer-events: none; }
        .toast-enter-active, .toast-leave-active { transition: all 0.3s ease; }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translate(-50%, 20px); }
        .no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .terminal-logs { font-family: 'Consolas', 'Monaco', monospace; line-height: 1.5; }
        /* æ–°å¢åŠ¨ç”»ç±» */
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 min-h-screen flex flex-col">
    <div id="app" class="flex flex-col min-h-screen">
        
        <div v-if="globalLoading" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[10000] flex items-center justify-center flex-col text-white">
            <i class="fas fa-circle-notch spinner text-4xl mb-4"></i>
            <p class="text-lg font-bold">{{ loadingText }}</p>
        </div>

        <transition name="toast">
            <div v-if="toast.show" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-[11000] flex flex-col items-center pointer-events-none">
                <div :class="['px-8 py-4 rounded-2xl shadow-2xl backdrop-blur-md flex items-center gap-3 text-lg font-bold border', 
                    toast.type === 'success' ? 'bg-white/90 dark:bg-gray-800/90 text-green-600 border-green-500/30' : 'bg-white/90 dark:bg-gray-800/90 text-red-500 border-red-500/30']">
                    <i :class="['fas', toast.type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle', 'text-2xl']"></i>
                    <span>{{ toast.msg }}</span>
                </div>
            </div>
        </transition>

        <header class="bg-white dark:bg-gray-800 shadow-md z-10 sticky top-0">
            <div class="container mx-auto px-4 h-16 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="/images/icon.png" alt="Logo" class="w-10 h-10 rounded-lg object-contain bg-gray-100 dark:bg-gray-700 p-1">
                    <span class="text-xl font-bold tracking-tight hidden md:block">ClashWeb</span>
                </div>
                <div class="flex items-center gap-4">
                    <button @click="openSettings" title="è®¾ç½®" class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition flex items-center justify-center text-gray-600 dark:text-gray-300">
                        <i class="fas fa-cog text-xl"></i>
                    </button>
                    <button @click="toggleTheme" title="åˆ‡æ¢ä¸»é¢˜" class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition flex items-center justify-center text-yellow-500">
                        <i :class="isDark ? 'fas fa-sun' : 'fas fa-moon'" class="text-xl"></i>
                    </button>
                    <a href="https://github.com/NikoYomi/clashweb" target="_blank" title="GitHub" class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition flex items-center justify-center text-gray-600 dark:text-gray-300">
                        <i class="fab fa-github text-xl"></i>
                    </a>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 py-8 max-w-5xl flex-1 flex flex-col gap-6">
            <div class="flex justify-between items-center w-full">
                <div class="flex gap-2 bg-gray-200 dark:bg-gray-800 rounded-lg p-1 overflow-x-auto no-scrollbar">
                    <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
                        :class="['px-5 py-2 rounded-md text-sm font-medium transition-all whitespace-nowrap', currentTab === tab.id ? 'bg-white dark:bg-gray-700 shadow text-primary' : 'text-gray-500 hover:text-gray-700 dark:hover:text-gray-300']">
                        <i :class="tab.icon" class="mr-2"></i> {{ tab.name }}
                    </button>
                </div>
                <button @click="restartContainers" title="é‡å¯å®¹å™¨" 
                    class="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-xl shadow-md hover:shadow-lg hover:-translate-y-0.5 transition font-bold text-sm whitespace-nowrap ml-4">
                    <i class="fas fa-power-off"></i> é‡å¯ Clash
                </button>
            </div>

            <div v-show="currentTab === 'home'" class="animate-fade-in flex flex-col gap-6">
                
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 border border-gray-100 dark:border-gray-700 text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-primary to-purple-600"></div>
                    <div class="w-16 h-16 bg-gradient-to-br from-indigo-100 to-purple-100 dark:from-indigo-900/30 dark:to-purple-900/30 text-primary rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-inner">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-1">è®¢é˜…è½¬æ¢</h2>
                    <p class="text-sm text-gray-500 mb-6">ä¸Šæ¬¡æ›´æ–°: <span class="font-mono font-bold text-gray-700 dark:text-gray-300">{{ analysis.update_time || 'ä»æœª' }}</span></p>
                    <div class="max-w-xl mx-auto flex flex-col gap-3 relative z-10">
                        <div class="relative">
                            <i class="fas fa-link absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input v-model="form.sub_url" type="text" placeholder="åœ¨æ­¤ç²˜è´´æœºåœºè®¢é˜…é“¾æ¥..." 
                                class="w-full pl-10 pr-4 py-4 rounded-xl bg-gray-50 dark:bg-gray-700 border-2 border-transparent focus:border-primary outline-none transition text-lg shadow-inner">
                        </div>
                        <button @click="downloadConfig" 
                            class="w-full py-4 bg-green-600 hover:bg-green-700 text-white font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all duration-200 flex items-center justify-center gap-2 rounded-xl text-lg">
                            <span>ç«‹å³æ›´æ–°è®¢é˜…</span><i class="fas fa-bolt"></i>
                        </button>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 border border-gray-100 dark:border-gray-700 relative overflow-hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold flex items-center gap-2">
                            <i class="fas fa-chart-pie text-blue-500"></i> 
                            <span>æµé‡ä½¿ç”¨æƒ…å†µ</span>
                            <component 
                                :is="configData.user_info?.web_url ? 'a' : 'span'"
                                :href="configData.user_info?.web_url"
                                :target="configData.user_info?.web_url ? '_blank' : ''"
                                v-if="configData.user_info?.name && configData.user_info.name !== 'æœªçŸ¥è®¢é˜…'" 
                                :class="['text-xs font-normal px-2 py-0.5 rounded-full flex items-center gap-1 transition-colors border', 
                                         configData.user_info?.web_url ? 'bg-blue-600 text-white hover:bg-blue-700 border-transparent shadow-sm cursor-pointer' : 'bg-blue-100 text-blue-600 dark:bg-blue-900/40 dark:text-blue-300 border-blue-200 dark:border-blue-800']">
                                <i v-if="configData.user_info?.web_url" class="fas fa-external-link-alt text-[10px]"></i>
                                {{ configData.user_info.name }}
                            </component>
                        </h3>
                        <span class="text-xs text-gray-400">æ›´æ–°äº: {{ configData.user_info?.update_time || 'æš‚æ— æ•°æ®' }}</span>
                    </div>
                    <div class="flex flex-col gap-2">
                        <div class="flex justify-between text-sm font-medium mb-1">
                            <span>å·²ç”¨: {{ formatBytes((configData.user_info?.upload || 0) + (configData.user_info?.download || 0)) }}</span>
                            <span>æ€»è®¡: {{ formatBytes(configData.user_info?.total || 0) }}</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4 overflow-hidden shadow-inner">
                            <div class="bg-gradient-to-r from-blue-500 to-cyan-400 h-4 rounded-full transition-all duration-1000 ease-out" :style="{ width: usagePercent + '%' }"></div>
                        </div>
                        <div class="flex justify-between items-center mt-2 text-xs text-gray-500 dark:text-gray-400">
                            <div class="flex gap-4">
                                <span><i class="fas fa-arrow-up text-green-500"></i> ä¸Šä¼ : {{ formatBytes(configData.user_info?.upload || 0) }}</span>
                                <span><i class="fas fa-arrow-down text-blue-500"></i> ä¸‹è½½: {{ formatBytes(configData.user_info?.download || 0) }}</span>
                            </div>
                            <div>
                                <i class="fas fa-hourglass-end"></i> è¿‡æœŸ: {{ formatDate(configData.user_info?.expire || 0) }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col gap-3">
                    <div class="flex flex-col gap-1 px-2">
                        <h3 class="text-lg font-bold flex items-center gap-2 text-gray-600 dark:text-gray-300">
                            <i class="fas fa-map-marker-alt text-primary"></i> èŠ‚ç‚¹åˆ†å¸ƒ (å…± {{ analysis.total_nodes }} ä¸ª)
                        </h3>
                        <div class="flex items-center gap-2 mt-1">
                            <div :class="['w-3 h-3 rounded-full transition-colors duration-300', configData.auto_update ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]' : 'bg-gray-300 dark:bg-gray-600']"></div>
                            <span v-if="configData.auto_update" class="text-xs font-medium text-green-600 dark:text-green-400">
                                å·²è®¾ç½® {{ configData.cron_expression }} æ›´æ–°ä¸€æ¬¡
                            </span>
                            <span v-else class="text-xs text-gray-400">
                                æœªè®¾ç½®è‡ªåŠ¨æ›´æ–°è®¢é˜…ï¼Œè¯·åœ¨è®¾ç½®ä¸­æ‰“å¼€
                            </span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        <div v-for="region in analysis.regions" :key="region.name" 
                             class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-100 dark:border-gray-700 flex flex-col justify-center h-24 shadow-sm hover:shadow-md transition relative overflow-hidden">
                            <div class="region-flag-bg">{{ region.icon }}</div>
                            <div class="relative z-10">
                                <span class="text-lg font-bold text-gray-800 dark:text-gray-100 block">{{ region.name }}</span>
                                <span class="text-sm font-medium text-primary bg-primary/10 px-2 py-0.5 rounded-full mt-1 inline-block">{{ region.count }} èŠ‚ç‚¹</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'groups'" class="flex flex-col gap-6 animate-fade-in">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 border-l-4 border-green-500">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">â• æ·»åŠ è‡ªå®šä¹‰ç­–ç•¥ç»„</h3>
                    <div class="grid md:grid-cols-12 gap-6">
                        <div class="md:col-span-4 flex flex-col gap-4">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">ç»„åç§° (ç‚¹å‡»å³ä¾§å›¾æ ‡å¯æ’å…¥)</label>
                                <input v-model="groupInput.name" type="text" placeholder="ä¾‹å¦‚ï¼šæ¼ç½‘ä¹‹é±¼" class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 outline-none focus:ring-2 focus:ring-green-500 text-lg">
                            </div>
                            <button @click="addNewGroup" 
                                class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold shadow-md hover:shadow-lg hover:-translate-y-0.5 transition-all duration-200 flex items-center justify-center gap-2 rounded-xl">
                                <i class="fas fa-plus"></i> ç¡®è®¤æ·»åŠ 
                            </button>
                            <p class="text-xs text-gray-400 leading-relaxed">* æ–°ç»„å°†è‡ªåŠ¨åŒ…å«è®¢é˜…ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚</p>
                        </div>
                        <div class="md:col-span-8">
                            <label class="block text-xs text-gray-500 mb-1">å›¾æ ‡é€‰æ‹©</label>
                            <div class="bg-gray-50 dark:bg-gray-900/50 p-2 rounded-xl border dark:border-gray-700 h-40 overflow-y-auto grid grid-cols-10 gap-1 content-start no-scrollbar">
                                <button v-for="icon in icons" :key="icon" @click="insertIcon(icon)"
                                    class="aspect-square rounded hover:bg-white dark:hover:bg-gray-700 hover:shadow-sm transition flex items-center justify-center border border-transparent hover:border-gray-200 dark:hover:border-gray-600 text-lg cursor-pointer select-none">
                                    {{ icon }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 flex-1 flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold flex items-center gap-2">ğŸ“‚ ç°æœ‰ç­–ç•¥ç»„ ({{ analysis.groups.length }})</h3>
                        <button @click="toggleGroupEdit" title="åˆ é™¤æ¨¡å¼" 
                            :class="isGroupEditMode ? 'bg-red-500 text-white shadow-md' : 'text-gray-500 bg-gray-100 dark:bg-gray-700 hover:text-red-500'"
                            class="w-10 h-10 rounded-lg flex items-center justify-center transition text-lg">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        <div v-for="g in analysis.groups" :key="g.name" @click="toggleGroupSelection(g.name)" 
                             :class="['p-4 rounded-xl border transition relative cursor-pointer flex items-center gap-3 min-h-[80px]', isGroupSelected(g.name) ? 'card-selected border-red-500' : 'bg-gray-50 dark:bg-gray-700 border-transparent hover:shadow-md']">
                            <div class="flex-1 min-w-0 flex flex-col justify-center pl-2">
                                <div class="font-medium truncate text-lg">{{ g.name }}</div>
                                <div class="text-xs text-gray-500 mt-1 flex items-center gap-1"><i class="fas fa-link"></i> {{ g.rule_count }} æ¡è§„åˆ™</div>
                            </div>
                            <div v-if="isGroupEditMode" class="absolute top-2 right-2">
                                <div :class="['w-5 h-5 rounded-full border flex items-center justify-center transition', isGroupSelected(g.name) ? 'bg-red-500 border-red-500 text-white' : 'border-gray-400 bg-white']"><i v-if="isGroupSelected(g.name)" class="fas fa-check text-xs"></i></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'rules'" class="flex flex-col gap-6 animate-fade-in">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 border-l-4 border-green-500">
                    <h3 class="text-lg font-bold mb-1 flex items-center gap-2">â• æ·»åŠ è‡ªå®šä¹‰è§„åˆ™</h3>
                    <p class="text-xs text-gray-400 mb-4 ml-7">å¯æ‰¹é‡æ·»åŠ ï¼Œä¸€è¡Œä¸€ä¸ª</p>
                    <div class="grid md:grid-cols-12 gap-6">
                        <div class="md:col-span-8 flex flex-col gap-4">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">å†…å®¹ (ç½‘å€/ip)</label>
                                <textarea v-model="ruleInput.raw" rows="4" class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 outline-none focus:ring-2 focus:ring-green-500 text-sm font-mono" placeholder="https://openai.com&#10;1.1.1.1"></textarea>
                            </div>
                            <button @click="addNewRules" 
                                class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold shadow-md hover:shadow-lg hover:-translate-y-0.5 transition-all duration-200 flex items-center justify-center gap-2 rounded-xl">
                                <i class="fas fa-plus"></i> æ·»åŠ è§„åˆ™
                            </button>
                        </div>
                        <div class="md:col-span-4 flex flex-col gap-4 mt-1">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">ç›®æ ‡ç­–ç•¥ç»„</label>
                                <div class="relative">
                                    <select v-model="ruleInput.target" class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 outline-none appearance-none text-sm">
                                        <option v-for="g in analysis.groups" :key="g.name" :value="g.name">{{ g.name }}</option>
                                    </select>
                                    <i class="fas fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">å¤‡æ³¨ <span class="text-gray-400 text-[10px]">(éå¿…è¦)</span></label>
                                <input v-model="ruleInput.remark" type="text" placeholder="ä¾‹å¦‚ï¼šAI" class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 outline-none focus:ring-2 focus:ring-green-500 text-sm">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 flex-1 flex flex-col h-[600px]">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold flex items-center gap-2">ğŸ“œ è§„åˆ™åˆ—è¡¨ ({{ analysis.rule_count }})</h3>
                        <div class="flex gap-2 items-center">
                            <input v-model="ruleSearch" type="text" placeholder="æœç´¢..." class="px-3 py-1 rounded bg-gray-100 dark:bg-gray-700 text-sm border border-transparent focus:border-green-500 outline-none">
                            <button @click="toggleRuleEdit" title="åˆ é™¤æ¨¡å¼" 
                                :class="isRuleEditMode ? 'bg-red-500 text-white shadow-md' : 'text-gray-500 bg-gray-100 dark:bg-gray-700 hover:text-red-500'"
                                class="w-10 h-10 rounded-lg flex items-center justify-center transition text-lg">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto bg-gray-50 dark:bg-gray-900 rounded-lg border dark:border-gray-700 p-2 text-sm font-mono">
                         <div v-for="(rule, idx) in filteredRules" :key="idx" @click="toggleRuleSelection(rule)" 
                             :class="['p-2 border-b border-gray-200 dark:border-gray-800 flex items-center gap-3 cursor-pointer hover:bg-white dark:hover:bg-gray-800 transition', isRuleSelected(rule) ? 'bg-red-50 dark:bg-red-900/20' : '']">
                            <div v-if="isRuleEditMode" :class="['w-4 h-4 rounded border flex-shrink-0 flex items-center justify-center', isRuleSelected(rule) ? 'bg-red-500 border-red-500 text-white' : 'border-gray-400 bg-white']"><i v-if="isRuleSelected(rule)" class="fas fa-check text-[10px]"></i></div>
                            <span class="text-gray-400 select-none w-8 text-right">{{ idx + 1 }}.</span>
                            <div class="truncate break-all flex-1">
                                <span class="">{{ rule.split('#')[0] }}</span>
                                <span v-if="rule.includes('#')" class="text-gray-400 text-xs ml-2 italic"># {{ rule.split('#')[1] }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'logs'" class="flex flex-col gap-4 animate-fade-in h-[700px]">
                <div class="flex justify-start items-center">
                    <h3 class="text-lg font-bold"><i class="fas fa-terminal text-primary"></i> å®æ—¶æ—¥å¿—</h3>
                </div>
                <div class="flex-1 bg-black text-green-400 font-mono text-xs md:text-sm p-4 rounded-xl overflow-y-auto border border-gray-700 shadow-inner terminal-logs" ref="logContainer">
                    <div v-if="logs.length === 0" class="text-gray-500 italic">æš‚æ— æ—¥å¿—æˆ–æ­£åœ¨åŠ è½½...</div>
                    <div v-for="(line, idx) in logs" :key="idx" class="whitespace-pre-wrap break-all hover:bg-gray-900">{{ line }}</div>
                </div>
            </div>

            <div v-if="(isGroupEditMode && selectedGroups.length > 0) || (isRuleEditMode && selectedRules.length > 0)" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-8 py-4 rounded-full shadow-2xl z-50 flex items-center gap-4 animate-bounce-slow">
                <span class="font-bold">å·²é€‰æ‹© {{ isGroupEditMode ? selectedGroups.length : selectedRules.length }} é¡¹</span>
                <button @click="initiateDelete" class="bg-white text-red-600 px-4 py-1 rounded-full font-bold hover:bg-gray-100 transition">ç«‹å³åˆ é™¤</button>
            </div>
        </main>

        <div v-if="showSettings" class="fixed inset-0 bg-black/60 backdrop-blur-sm modal-mask flex items-center justify-center p-4" @click.self="showSettings = false">
            <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-4xl shadow-2xl overflow-hidden transform transition-all flex flex-col md:flex-row h-[70vh] md:h-[600px]">
                
                <div class="w-full md:w-64 bg-gray-50 dark:bg-gray-900/50 border-r border-gray-100 dark:border-gray-700 flex flex-col">
                    <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                        <h3 class="text-xl font-bold flex items-center gap-2"><i class="fas fa-sliders-h text-primary"></i> è®¾ç½®ä¸­å¿ƒ</h3>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 flex flex-col gap-2">
                        <button @click="settingTab = 'basic'" 
                            :class="['text-left px-4 py-3 rounded-xl transition flex items-center gap-3 font-medium', settingTab === 'basic' ? 'bg-white dark:bg-gray-800 shadow text-primary' : 'text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800']">
                            <i class="fas fa-cog w-5"></i> åŸºç¡€è®¾ç½®
                        </button>
                        <button @click="settingTab = 'history'" 
                            :class="['text-left px-4 py-3 rounded-xl transition flex items-center gap-3 font-medium', settingTab === 'history' ? 'bg-white dark:bg-gray-800 shadow text-primary' : 'text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800']">
                            <i class="fas fa-history w-5"></i> è®¢é˜…å†å²
                        </button>
                        <button @click="settingTab = 'backup'" 
                            :class="['text-left px-4 py-3 rounded-xl transition flex items-center gap-3 font-medium', settingTab === 'backup' ? 'bg-white dark:bg-gray-800 shadow text-primary' : 'text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800']">
                            <i class="fas fa-save w-5"></i> å¤‡ä»½ä¸è¿˜åŸ
                        </button>
                    </div>
                    <div class="p-4 border-t border-gray-100 dark:border-gray-700 md:hidden">
                        <button @click="showSettings = false" class="w-full py-2 bg-gray-200 dark:bg-gray-700 rounded-lg">å…³é—­</button>
                    </div>
                </div>

                <div class="flex-1 flex flex-col h-full overflow-hidden relative">
                    <div class="flex-1 overflow-y-hidden p-8 relative">
                        
                        <div v-show="settingTab === 'basic'" class="flex flex-col gap-6 animate-fade-in">
                            <h4 class="text-lg font-bold border-l-4 border-primary pl-3">æ ¸å¿ƒé…ç½®</h4>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-bold mb-2 text-gray-500">è½¬æ¢åç«¯åœ°å€</label>
                                    <input v-model="configData.sub_backend" type="text" class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-700 outline-none focus:ring-2 focus:ring-primary" placeholder="è¾“å…¥å®Œæ•´åç«¯åœ°å€ï¼Œæœ€åä¸è¦/">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-2 text-gray-500">Clash å®¹å™¨åç§°</label>
                                    <input v-model="configData.restart_containers" type="text" class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-700 outline-none focus:ring-2 focus:ring-primary" placeholder="clashç›¸å…³å®¹å™¨åï¼Œå¤šä¸ªå®¹å™¨ä»¥è‹±æ–‡,éš”å¼€">
                                </div>
                            </div>

                            <h4 class="text-lg font-bold border-l-4 border-green-500 pl-3 mt-4">è‡ªåŠ¨åŒ–</h4>
                            <div class="p-5 bg-gray-50 dark:bg-gray-700/30 rounded-xl border border-gray-100 dark:border-gray-700">
                                <div class="flex items-center justify-between mb-4">
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-200">å®šæ—¶è®¾ç½®</label>
                                        <p class="text-xs text-gray-400">å¯ç”¨åå°†æ ¹æ® Cron è¡¨è¾¾å¼è‡ªåŠ¨æ›´æ–°è®¢é˜…</p>
                                    </div>
                                    <div @click="configData.auto_update = !configData.auto_update" 
                                            :class="['w-12 h-6 rounded-full p-1 cursor-pointer transition-colors', configData.auto_update ? 'bg-green-500' : 'bg-gray-300 dark:bg-gray-600']">
                                        <div :class="['bg-white w-4 h-4 rounded-full shadow-md transform transition-transform duration-200', configData.auto_update ? 'translate-x-6' : 'translate-x-0']"></div>
                                    </div>
                                </div>
                                <div v-if="configData.auto_update" class="animate-fade-in">
                                    <input v-model="configData.cron_expression" type="text" class="w-full p-2 rounded bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 text-sm font-mono" placeholder="0 4 * * *">
                                    <p class="text-xs text-gray-400 mt-1"><i class="fas fa-info-circle"></i> ç¤ºä¾‹: <code>0 4 * * *</code> (æ¯å¤©å‡Œæ™¨4ç‚¹)</p>
                                </div>
                            </div>
                        </div>

                        <div v-show="settingTab === 'history'" class="flex flex-col gap-6 animate-fade-in">
                            <div class="flex justify-between items-center">
                                <h4 class="text-lg font-bold border-l-4 border-purple-500 pl-3">å†å²è®°å½• ({{ configData.sub_history ? configData.sub_history.length : 0 }})</h4>
                                <span class="text-xs text-gray-400">ç‚¹å‡»åˆ—è¡¨é¡¹å³å¯æ›´æ–°åº”ç”¨</span>
                            </div>

                            <div v-if="configData.sub_history && configData.sub_history.length > 0" class="flex flex-col gap-3">
                                <div v-for="(item, idx) in configData.sub_history" :key="idx" 
                                     class="group relative bg-gray-50 dark:bg-gray-700/40 hover:bg-white dark:hover:bg-gray-700 border border-transparent hover:border-gray-200 dark:hover:border-gray-600 rounded-xl p-4 transition-all shadow-sm hover:shadow-md cursor-pointer"
                                     @click="applyHistory(item.url)">
                                    
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="flex items-center gap-2">
                                            <span class="font-bold text-lg text-gray-800 dark:text-gray-100">{{ item.name || 'æœªçŸ¥è®¢é˜…' }}</span>
                                            <a v-if="item.web_url" :href="item.web_url" target="_blank" @click.stop class="text-xs bg-gray-200 dark:bg-gray-600 px-1.5 py-0.5 rounded hover:bg-blue-500 hover:text-white transition text-gray-500 dark:text-gray-400"><i class="fas fa-external-link-alt"></i></a>
                                            <span v-if="idx === 0" class="bg-green-100 text-green-600 text-[10px] px-1.5 py-0.5 rounded border border-green-200 ml-1">æ­£åœ¨ä½¿ç”¨</span>
                                        </div>
                                        <div v-if="idx !== 0" class="text-xs text-gray-400 font-mono flex items-center gap-1">
                                            <i class="far fa-clock"></i>ä¸Šæ¬¡ä½¿ç”¨: {{ item.date }}
                                        </div>
                                    </div>

                                    <div class="mb-2">
                                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                                            <span>ç”¨é‡: {{ formatBytes((item.upload||0)+(item.download||0)) }}</span>
                                            <span>æ€»: {{ formatBytes(item.total||0) }}</span>
                                        </div>
                                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-1.5 overflow-hidden">
                                            <div class="bg-blue-500 h-1.5 rounded-full" :style="{width: Math.min(100, (((item.upload||0)+(item.download||0))/(item.total||1))*100)+'%'}"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-between items-center text-[10px] text-gray-400 mt-1">
                                        <div class="truncate max-w-[200px] font-mono">{{ item.url }}</div>
                                        <div v-if="item.expire"><span class="text-red-500">âŒ›ï¸</span>è¿‡æœŸ: {{ formatDate(item.expire) }}</div> <span v-else class="text-gray-400">âœ… æ°¸ä¹…æœ‰æ•ˆ</span>
                                    </div>

                                    <button @click.stop="deleteHistory(idx)" title="åˆ é™¤æ­¤è®°å½•" 
                                        class="absolute top-2 right-2 w-6 h-6 hover:bg-red-500 hover:text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition shadow-sm text-xs text-gray-300">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div v-else class="flex flex-col items-center justify-center py-12 text-gray-400 opacity-50">
                                <i class="fas fa-history text-4xl mb-2"></i>
                                <p>æš‚æ— å†å²è®°å½•</p>
                            </div>
                        </div>

                        <div v-show="settingTab === 'backup'" class="flex flex-col gap-6 animate-fade-in">
                            <h4 class="text-lg font-bold border-l-4 border-orange-500 pl-3">æ•°æ®ç®¡ç†</h4>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-blue-50 dark:bg-blue-900/10 border border-blue-100 dark:border-blue-900/30 rounded-xl p-5 flex flex-col items-center text-center hover:shadow-md transition">
                                    <div class="w-12 h-12 bg-blue-100 dark:bg-blue-800 text-blue-600 dark:text-blue-300 rounded-full flex items-center justify-center text-xl mb-3">
                                        <i class="fas fa-cloud-download-alt"></i>
                                    </div>
                                    <h5 class="font-bold text-gray-800 dark:text-gray-200 mb-1">å¯¼å‡ºé…ç½®</h5>
                                    <p class="text-xs text-gray-500 mb-4 h-8">å°†å½“å‰é¢æ¿çš„æ‰€æœ‰è®¾ç½®ã€è‡ªå®šä¹‰ç»„å’Œè§„åˆ™å¯¼å‡ºä¸º JSONã€‚</p>
                                    
                                    <label class="flex items-center gap-2 text-xs text-gray-600 dark:text-gray-400 mb-3 cursor-pointer select-none bg-white dark:bg-gray-800 px-3 py-1 rounded-full border border-gray-200 dark:border-gray-700">
                                        <input type="checkbox" v-model="backupOpts.includeSub" class="rounded text-blue-600 focus:ring-blue-500"> 
                                        åŒ…å«æ•æ„Ÿè®¢é˜…é“¾æ¥
                                    </label>
                                    
                                    <a :href="backupUrl" target="_blank" class="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold text-sm transition">
                                        <i class="fas fa-download mr-1"></i> ä¸‹è½½å¤‡ä»½æ–‡ä»¶
                                    </a>
                                </div>

                                <div class="bg-orange-50 dark:bg-orange-900/10 border border-orange-100 dark:border-orange-900/30 rounded-xl p-5 flex flex-col items-center text-center hover:shadow-md transition">
                                    <div class="w-12 h-12 bg-orange-100 dark:bg-orange-800 text-orange-600 dark:text-orange-300 rounded-full flex items-center justify-center text-xl mb-3">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <h5 class="font-bold text-gray-800 dark:text-gray-200 mb-1">å¯¼å…¥é…ç½®</h5>
                                    <p class="text-xs text-gray-500 mb-4 h-8">ä¸Šä¼ ä¹‹å‰å¤‡ä»½çš„ JSON æ–‡ä»¶ä»¥æ¢å¤é¢æ¿è®¾ç½®ã€‚</p>

                                    <label class="flex items-center gap-2 text-xs text-gray-600 dark:text-gray-400 mb-3 cursor-pointer select-none bg-white dark:bg-gray-800 px-3 py-1 rounded-full border border-gray-200 dark:border-gray-700">
                                        <input type="checkbox" v-model="restoreOpts.restoreSub" class="rounded text-orange-600 focus:ring-orange-500"> 
                                        è¦†ç›–å½“å‰è®¢é˜…é“¾æ¥
                                    </label>

                                    <div class="relative w-full">
                                        <input type="file" @change="restoreConfig" accept=".json" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                                        <button class="w-full py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-bold text-sm transition">
                                            <i class="fas fa-upload mr-1"></i> é€‰æ‹©æ–‡ä»¶è¿˜åŸ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="p-4 border-t border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800 flex justify-end gap-3 z-20">
                        <button @click="showSettings = false" class="px-5 py-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition font-medium">å–æ¶ˆ</button>
                        <button @click="saveSettings" class="px-6 py-2 bg-primary hover:bg-indigo-600 text-white rounded-lg font-bold shadow-lg shadow-indigo-500/30 transition flex items-center gap-2">
                            <i class="fas fa-save"></i> ä¿å­˜è®¾ç½®
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="confirmModal.show" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[10000] flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md p-6 shadow-2xl border-2 border-red-500/50 transform transition-all scale-100">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-red-100 dark:bg-red-900/30 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl"><i class="fas fa-trash-alt"></i></div>
                    <h3 class="text-xl font-bold mb-2">çº§è”åˆ é™¤ç¡®è®¤</h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm">åˆ é™¤é€‰ä¸­çš„ç»„å°†åŒæ—¶ç§»é™¤<br><span class="text-red-500 font-bold text-lg">{{ confirmModal.count }}</span> æ¡å…³è”è§„åˆ™ã€‚</p>
                </div>
                <div class="flex gap-3">
                    <button @click="confirmModal.show = false" class="flex-1 py-3 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-xl font-bold transition">å–æ¶ˆ</button>
                    <button @click="performDelete" class="flex-1 py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold shadow-lg shadow-red-600/30 transition">ç¡®è®¤åˆ é™¤</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        const { createApp, ref, reactive, computed, onMounted, watch } = Vue

        createApp({
            setup() {
                const isDark = ref(true)
                const globalLoading = ref(false)
                const loadingText = ref('')
                const showSettings = ref(false)
                const settingTab = ref('basic') // [ä¿®æ”¹] æ§åˆ¶è®¾ç½®é¢æ¿çš„ Tab
                const currentTab = ref('home')
                const statusMsg = ref('')
                const statusType = ref('success')
                const toast = reactive({ show: false, msg: '', type: 'success' })
                const confirmModal = reactive({ show: false, count: 0 })
                
                // æ—¥å¿—æ•°æ®
                const logs = ref([])
                const logContainer = ref(null)
                let logInterval = null

                const icons = [
                    'ğŸš€','âœˆï¸','â˜ï¸','ğŸ”’','ğŸ›¡ï¸','ğŸ“¶','ğŸŒ','ğŸ ','ğŸ¢','ğŸ“º','ğŸ¬','ğŸµ','ğŸ®','ğŸ','ğŸ¤–','ğŸ™','ğŸ±','ğŸ¦„','ğŸ”¥','âš¡',
                    'ğŸ’¬','ğŸ›’','ğŸ’¾','ğŸ“¹','ğŸ“·','ğŸ“','ğŸ”','ğŸ›‘','âœ…','â™»ï¸','â™¾ï¸','ğŸ“¡','ğŸš¦','ğŸš¨','ğŸš§','ğŸ”§','ğŸ”¨','âš™ï¸','ğŸ’','ğŸ”‘',
                    'ğŸ””','ğŸ“¢','ğŸ¦ ','ğŸ§¬','ğŸ’Š','ğŸ’‰','ğŸ©¸','ğŸ”­','ğŸ”¬','ğŸŒ¡ï¸','ğŸ§ª','ğŸ§«','ğŸ§¬','ğŸ§¸','ğŸ','ğŸˆ','ğŸ‰','ğŸ¨','ğŸ­','ğŸª'
                ]

                const tabs = [
                    { id: 'home', name: 'ä»ªè¡¨ç›˜', icon: 'fas fa-tachometer-alt' },
                    { id: 'groups', name: 'ä»£ç†ç»„', icon: 'fas fa-layer-group' },
                    { id: 'rules', name: 'è§„åˆ™ç®¡ç†', icon: 'fas fa-list-ul' },
                    { id: 'logs', name: 'è¿è¡Œæ—¥å¿—', icon: 'fas fa-terminal' } 
                ]

                const form = reactive({ sub_url: '' })
                const configData = reactive({ 
                    sub_backend: '', 
                    sub_url: '', 
                    restart_containers: '', 
                    auto_update: false, 
                    cron_expression: '0 4 * * *', 
                    // [ä¿®æ”¹] å¢åŠ  name å­—æ®µ
                    user_info: { name: '', web_url: '', upload: 0, download: 0, total: 0, expire: 0, update_time: '' },
                    sub_history: [], 
                    add_groups: [], 
                    del_groups: [], 
                    add_rules: [], 
                    del_rules: [] 
                })
                const analysis = reactive({ groups: [], rules: [], rule_count: 0, regions: [], total_nodes: 0, update_time: '' })
                
                const groupInput = reactive({ name: '' })
                const isGroupEditMode = ref(false)
                const selectedGroups = ref([])
                const ruleInput = reactive({ raw: '', target: '', remark: '' })
                const isRuleEditMode = ref(false)
                const selectedRules = ref([])
                const ruleSearch = ref('')

                // å¤‡ä»½è¿˜åŸé€‰é¡¹
                const backupOpts = reactive({ includeSub: false })
                const restoreOpts = reactive({ restoreSub: false })

                // å·¥å…·å‡½æ•°
                const formatBytes = (bytes) => {
                    if (!bytes || bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                }

                const formatDate = (timestamp) => {
                    if (!timestamp || timestamp === 0) return 'æ— é™æœŸ';
                    return new Date(timestamp * 1000).toLocaleDateString() + ' ' + new Date(timestamp * 1000).toLocaleTimeString();
                }

                const usagePercent = computed(() => {
                    // å®‰å…¨æ£€æŸ¥
                    if (!configData.user_info || !configData.user_info.total || configData.user_info.total === 0) return 0;
                    const used = (configData.user_info.upload || 0) + (configData.user_info.download || 0);
                    return Math.min(100, (used / configData.user_info.total) * 100);
                });

                const showLoading = (t) => { loadingText.value = t; globalLoading.value = true }
                const hideLoading = () => { globalLoading.value = false }
                const showToast = (msg, type = 'success') => {
                    toast.msg = msg; toast.type = type; toast.show = true;
                    setTimeout(() => toast.show = false, 2500);
                }
                const insertIcon = (icon) => { groupInput.name = icon + ' ' + groupInput.name }
                
                const getRuleTarget = (ruleStr) => {
                    try {
                        const clean = ruleStr.split('#')[0].trim();
                        const parts = clean.split(',');
                        if(parts.length >= 3) return parts[2].trim();
                    } catch(e){}
                    return "";
                }

                const backupUrl = computed(() => `/api/backup?include_sub=${backupOpts.includeSub}`)

                const loadData = async () => {
                    try {
                        const ts = new Date().getTime()
                        const [resData, resAnalysis] = await Promise.all([
                            fetch('/api/data?t='+ts).then(r=>r.json()),
                            fetch('/api/analysis?t='+ts).then(r=>r.json())
                        ])
                        
                        // ç¡®ä¿ user_info å­˜åœ¨
                        if(!resData.user_info) resData.user_info = { name: '', web_url: '', upload: 0, download: 0, total: 0, expire: 0, update_time: '' };
                        
                        Object.assign(configData, {
                            sub_backend: "", sub_url: "", restart_containers: "", auto_update: false, 
                            cron_expression: "0 4 * * *", sub_history: [], add_groups: [], 
                            del_groups: [], add_rules: [], del_rules: [], ...resData
                        })
                        form.sub_url = configData.sub_url
                        if(resAnalysis.status === 'success') {
                            Object.assign(analysis, resAnalysis)
                            if(analysis.groups.length > 0 && !ruleInput.target) ruleInput.target = analysis.groups[0].name
                        }
                    } catch(e) { console.error(e) }
                }

                const saveData = async () => {
                    const payload = JSON.parse(JSON.stringify(configData))
                    payload.sub_url = form.sub_url
                    const res = await fetch('/api/data', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) })
                    if(!res.ok) throw new Error("ä¿å­˜å¤±è´¥");
                }

                const fetchLogs = async () => {
                    try {
                        const res = await fetch('/api/logs?lines=200')
                        const data = await res.json()
                        logs.value = data.logs
                        if(logContainer.value) {
                            setTimeout(() => logContainer.value.scrollTop = logContainer.value.scrollHeight, 100)
                        }
                    } catch(e) { console.error(e) }
                }

                watch(currentTab, (newTab) => {
                    if(newTab === 'logs') {
                        fetchLogs()
                        logInterval = setInterval(fetchLogs, 5000)
                    } else {
                        if(logInterval) { clearInterval(logInterval); logInterval = null; }
                    }
                })

                const cleanRuleInput = (rawLine) => {
                    let line = rawLine.trim();
                    if(!line) return null;
                    let hostname = '';
                    try {
                        const urlStr = /^[a-zA-Z][a-zA-Z\d+\-.]*:/.test(line) ? line : 'http://' + line;
                        const u = new URL(urlStr);
                        hostname = u.hostname.replace(/^\[|\]$/g, '');
                    } catch (e) { hostname = line.split('/')[0].split(':')[0]; }
                    if (!hostname) return null;
                    if (/^(\d{1,3}\.){3}\d{1,3}$/.test(hostname)) return { type: 'IP-CIDR', value: hostname + '/32' };
                    if (/^(\d{1,3}\.){3}\d{1,3}\/\d{1,2}$/.test(line)) return { type: 'IP-CIDR', value: line };
                    if (hostname.includes(':')) return { type: 'IP-CIDR6', value: hostname + '/128' };
                    const dotCount = (hostname.match(/\./g) || []).length;
                    if (dotCount <= 1) return { type: 'DOMAIN-SUFFIX', value: hostname };
                    return { type: 'DOMAIN', value: hostname };
                }

                const addNewRules = async () => {
                    if(!ruleInput.raw || !ruleInput.target) return showToast("è¯·å®Œå–„ä¿¡æ¯", "error")
                    showLoading('æ·»åŠ è§„åˆ™...')
                    try {
                        const lines = ruleInput.raw.split('\n')
                        let addedCount = 0
                        lines.forEach(rawLine => {
                            const res = cleanRuleInput(rawLine)
                            if(res) {
                                let ruleStr = `${res.type},${res.value},${ruleInput.target}`
                                if(ruleInput.remark) ruleStr += ` # ${ruleInput.remark}`
                                const cleanStr = ruleStr.split('#')[0].trim();
                                const alreadyExists = analysis.rules.some(r => r.split('#')[0].trim() === cleanStr) || configData.add_rules.some(r => r.split('#')[0].trim() === cleanStr);
                                if(!alreadyExists) { configData.add_rules.unshift(ruleStr); addedCount++; }
                            }
                        })
                        if(addedCount > 0) {
                            await saveData()
                            if(form.sub_url) await fetch('/api/download', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ url: form.sub_url }) })
                            await loadData()
                            ruleInput.raw = ''; ruleInput.remark = '';
                            showToast(`å·²æ·»åŠ  ${addedCount} æ¡è§„åˆ™`)
                        } else { showToast('è§„åˆ™å·²å­˜åœ¨æˆ–æ— æ•ˆ', 'error') }
                    } catch(e) { showToast(e.message, 'error') } finally { hideLoading() }
                }

                const addNewGroup = async () => {
                    if(!groupInput.name) return showToast("è¯·è¾“å…¥ç»„å", "error")
                    if(analysis.groups.find(g => g.name === groupInput.name) || configData.add_groups.find(g => g.name === groupInput.name)) return showToast("ç»„åå·²å­˜åœ¨", "error")
                    showLoading('æ·»åŠ ç»„...')
                    try {
                        configData.add_groups.unshift({ name: groupInput.name, type: 'select', proxies: ["DIRECT", "REJECT"] })
                        await saveData()
                        if(form.sub_url) await fetch('/api/download', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ url: form.sub_url }) })
                        await loadData()
                        groupInput.name = ''; showToast('ç»„æ·»åŠ æˆåŠŸ')
                    } catch(e) { showToast(e.message, "error") } finally { hideLoading() }
                }

                const initiateDelete = () => {
                    if(isGroupEditMode.value && selectedGroups.value.length > 0) {
                        const affectedRuleCount = selectedGroups.value.reduce((acc, groupName) => {
                            return acc + analysis.rules.filter(r => {
                                const target = getRuleTarget(r);
                                return target === groupName;
                            }).length
                        }, 0)
                        if(affectedRuleCount > 0) { confirmModal.count = affectedRuleCount; confirmModal.show = true; return; }
                    }
                    performDelete();
                }

                const performDelete = async () => {
                    confirmModal.show = false; showLoading('åˆ é™¤ä¸­...')
                    try {
                        if(isGroupEditMode.value) {
                            selectedGroups.value.forEach(name => {
                                const idx = configData.add_groups.findIndex(g => g.name === name)
                                if(idx > -1) configData.add_groups.splice(idx, 1)
                                else if(!configData.del_groups.includes(name)) configData.del_groups.push(name)
                                configData.add_rules = configData.add_rules.filter(r => getRuleTarget(r) !== name);
                            })
                            selectedGroups.value = []
                            isGroupEditMode.value = false
                        } else {
                            selectedRules.value.forEach(rule => {
                                const targetClean = rule.split('#')[0].trim();
                                const idx = configData.add_rules.findIndex(r => r.split('#')[0].trim() === targetClean)
                                if(idx > -1) configData.add_rules.splice(idx, 1)
                                else if(!configData.del_rules.includes(targetClean)) configData.del_rules.push(targetClean)
                            })
                            selectedRules.value = []
                            isRuleEditMode.value = false
                        }
                        await saveData()
                        if(form.sub_url) await fetch('/api/download', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ url: form.sub_url }) })
                        await loadData()
                        showToast('åˆ é™¤æˆåŠŸ')
                    } catch(e) { showToast(e.message, "error") } finally { hideLoading() }
                }

                const restoreConfig = async (event) => {
                    const file = event.target.files[0]; if(!file) return;
                    showLoading('è¿˜åŸä¸­...')
                    const formData = new FormData(); 
                    formData.append('file', file);
                    formData.append('restore_sub', restoreOpts.restoreSub); 
                    try {
                        const res = await fetch('/api/restore', { method: 'POST', body: formData })
                        if(!res.ok) throw new Error("è¿˜åŸå¤±è´¥")
                        await loadData()
                        if(configData.sub_url) {
                             showToast('é…ç½®è¿˜åŸæˆåŠŸï¼Œæ­£åœ¨åº”ç”¨...')
                             await fetch('/api/download', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ url: configData.sub_url }) })
                             await loadData()
                        }
                        showToast('è¿˜åŸå¹¶åº”ç”¨æˆåŠŸ'); showSettings.value = false;
                    } catch(e) { showToast(e.message, "error") } finally { hideLoading() }
                }

                const applyHistory = async (url) => {
                    form.sub_url = url;
                    await downloadConfig();
                }
                
                const deleteHistory = async (idx) => {
                    configData.sub_history.splice(idx, 1);
                    await saveData();
                }

                const downloadConfig = async () => {
                    if(!configData.sub_backend) { showSettings.value = true; return showToast("è¯·å…ˆè®¾ç½®è½¬æ¢åç«¯", "error"); }
                    if(!form.sub_url) return showToast("è¯·è¾“å…¥è®¢é˜…é“¾æ¥", "error")
                    showLoading('æ›´æ–°ä¸­...')
                    statusMsg.value = ""
                    try {
                        await saveData()
                        const res = await fetch('/api/download', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ url: form.sub_url }) })
                        if(!res.ok) { const d = await res.json(); throw new Error(d.detail); }
                        statusType.value = 'success'; statusMsg.value = "âœ… è®¢é˜…æ›´æ–°æˆåŠŸ"
                        await loadData(); showToast("è®¢é˜…æ›´æ–°æˆåŠŸ")
                    } catch(e) { statusType.value = 'error'; statusMsg.value = "âŒ " + e.message; showToast(e.message, "error") } finally { hideLoading() }
                }

                const restartContainers = async () => {
                    if(!configDataã€‚restart_containers) { showSettingsã€‚value = true; return showToast("è¯·å…ˆé…ç½®å®¹å™¨åç§°"ï¼Œ "error"); }
                    showLoading('æ­£åœ¨é‡å¯å®¹å™¨...')
                    try {
                        const res = await fetch('/api/restart_containers', { method: 'POST' })
                        const data = await res.json()
                        if(!resã€‚ok) throw new é”™è¯¯(dataã€‚detail || "é‡å¯å¤±è´¥")
                        showToast(data.msg)
                    } catch(e) { showToast(eã€‚messageï¼Œ "error") } finally { hideLoading() }
                }

                const saveSettings = async () => {
                    showLoading('ä¿å­˜...')
                    try { await saveData(); showSettingsã€‚value = false; showToast('è®¾ç½®å·²ä¿å­˜'); }
                    catch(e) { showToast("ä¿å­˜å¤±è´¥", "error"); } finally { hideLoading(); }
                }

                const openSettings = () => { showSettings.value = true }
                const toggleTheme = () => {
                    isDarkã€‚value = !isDarkã€‚value;
                    documentã€‚documentElementã€‚classListã€‚toggle('dark'ï¼Œ isDark.value);
                    localStorageã€‚setItem('theme'ï¼Œ isDarkã€‚value ? 'dark' : 'light');
                }
                const toggleGroupEdit = () => { isGroupEditModeã€‚value = !isGroupEditModeã€‚value; selectedGroupsã€‚value = [] }
                const isGroupSelected = (n) => selectedGroupsã€‚valueã€‚includes(n)
                const toggleGroupSelection = (n) => { if(isGroupEditModeã€‚value) isGroupSelected(n) ? selectedGroups.value.splice(selectedGroupsã€‚valueã€‚indexOf(n)ï¼Œ 1) : selectedGroups.value.push(n) }
                const toggleRuleEdit = () => { isRuleEditModeã€‚value = !isRuleEditModeã€‚value; selectedRulesã€‚value = [] }
                const isRuleSelected = (r) => selectedRulesã€‚valueã€‚includes(r)
                const toggleRuleSelection = (r) => { if(isRuleEditMode.value) isRuleSelected(r) ? selectedRules.value.splice(selectedRules.value.indexOf(r), 1) : selectedRules.value.push(r) }
                const filteredRules = computed(() => {
                    if (!analysisã€‚rules) return []
                    const key = ruleSearch.value.toLowerCase()
                    if (!key) return analysis.rules.slice(0, 100)
                    return analysisã€‚rulesã€‚filter(r => rã€‚toLowerCase()ã€‚includes(key))ã€‚slice(0ï¼Œ 100)
                })

                onMounted(() => {
                    // ä»localStorageè¯»å–ä¸»é¢˜åå¥½
                    const savedTheme = localStorageã€‚getItem('theme');
                    if (savedTheme === 'light') {
                        isDark.value = false;
                        document.documentElementã€‚classListã€‚remove('dark');
                    } else {
                        isDark.value = true;
                        document.documentElement.classList.add('dark');
                    }
                    loadData();
                })

                return { 
                    isDark, toggleTheme, globalLoading, loadingText, showSettings, openSettings, currentTab, tabs,
                    form, configDataï¼Œ analysisï¼Œ statusMsgï¼Œ statusTypeï¼Œ iconsï¼Œ toast, showToast, confirmModalï¼Œ
                    groupInput, insertIconï¼Œ addNewGroupï¼Œ isGroupEditModeï¼Œ selectedGroupsï¼Œ toggleGroupEditï¼Œ isGroupSelectedï¼Œ toggleGroupSelectionï¼Œ
                    ruleInput, addNewRulesï¼Œ isRuleEditModeï¼Œ selectedRulesï¼Œ toggleRuleEditï¼Œ isRuleSelectedï¼Œ toggleRuleSelectionï¼Œ ruleSearch, filteredRulesï¼Œ
                    initiateDelete, performDeleteï¼Œ saveSettingsï¼Œ downloadConfigï¼Œ restoreConfigï¼Œ restartContainersï¼Œ applyHistoryï¼Œ deleteHistoryï¼Œ
                    backupOpts, restoreOptsï¼Œ backupUrlï¼Œ logsï¼Œ fetchLogsï¼Œ logContainerï¼Œ
                    // [ä¿®æ”¹] å¯¼å‡ºæ–°çš„å˜é‡
                    formatBytes, formatDateï¼Œ usagePercentï¼Œ settingTab
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
