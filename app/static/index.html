<!DOCTYPE html>
<html lang="zh-CN" class="dark">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ClashWeb é¢æ¿</title>
    <link rel="icon" href="/images/favicon.ico">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { primary: '#6366f1', action: '#16a34a' } } }
        }
    </script>

    <style>
        :root { --card-radius: 20px; }
        html { overflow-y: scroll; }
        body { transition: background-color .3s ease, color .3s ease; -webkit-font-smoothing: antialiased; }

        /* å¡ç‰‡åŸºç¡€æ ·å¼ */
        .card-bg {
            background: #ffffff;
            border-radius: var(--card-radius);
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            transition: box-shadow .3s ease;
        }
        html.dark .card-bg {
            background: #1e293b;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        .smooth-card {
            border-radius: calc(var(--card-radius) - 2px);
            transition: all .3s ease;
        }
        .smooth-card:hover { box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15); }
        html.dark .smooth-card:hover { box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6); border-color: rgba(99, 102, 241, 0.3); }

        /* é€‰ä¸­çŠ¶æ€ */
        .card-selected { border-color: #ef4444 !important; background-color: rgba(239, 68, 68, 0.05) !important; }
        html.dark .card-selected { background-color: rgba(239, 68, 68, 0.15) !important; }

        /* æŒ‰é’®ä¸äº¤äº’ */
        .btn-soft { border-radius: 10px; padding: .5rem .8rem; transition: all .2s ease; }
        .btn-soft:active { opacity: 0.7; transform: scale(0.98); }

        /* èƒŒæ™¯çº¹ç† */
        .bg-dot-pattern {
            background-color: #f9f9f9;
            background-image: radial-gradient(#d3d3d3 0.5px, transparent 0.5px);
            background-size: 24px 24px;
            background-attachment: fixed;
        }
        html.dark .bg-dot-pattern {
            background-color: #0f1724;
            background-image: radial-gradient(rgba(99, 102, 241, 0.15) 0.5px, transparent 0.5px);
        }

        /* åŒºåŸŸå¡ç‰‡ */
        .region-card { position: relative; overflow: hidden; padding: 14px; border-radius: 16px; transition: border-color .2s; }
        .region-card:hover { border-color: rgba(99, 102, 241, 0.5); }
        .region-flag-bg {
            position: absolute; right: -10px; bottom: -20px; font-size: 5.5rem; opacity: 0.06;
            filter: grayscale(20%); pointer-events: none; transform: rotate(-12deg);
        }

        /* åŠ¨ç”» */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .switch-enter-active, .switch-leave-active { transition: opacity 0.3s ease, transform 0.3s ease; }
        .switch-enter-from, .switch-leave-to { opacity: 0; transform: scale(0.98); }
        .toast-enter-active, .toast-leave-active { transition: all .3s ease; }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translate(-50%, -20px); }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.5); border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(156, 163, 175, 0.8); }
        .terminal-logs { font-family: 'Consolas', monospace; font-size: 0.85rem; line-height: 1.5; }
        .modal-mask { z-index: 9000; }

        /* æ ‡ç­¾æ ·å¼ */
        .badge-native { background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.2); }
        html.dark .badge-native { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .badge-custom { background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.2); }
        html.dark .badge-custom { background: rgba(16, 185, 129, 0.2); color: #34d399; }
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 min-h-screen flex flex-col bg-dot-pattern">
    <div id="app" class="flex flex-col min-h-screen relative">

        <div v-if="globalLoading" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[10000] flex items-center justify-center flex-col text-white transition-opacity duration-300">
            <i class="fas fa-circle-notch spinner text-4xl mb-4 animate-spin"></i>
            <p class="text-lg font-bold tracking-wider">{{ loadingText }}</p>
        </div>

        <transition name="toast">
            <div v-if="toast.show" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-[11000] flex flex-col items-center pointer-events-none">
                <div :class="['px-8 py-4 rounded-2xl shadow-2xl backdrop-blur-md flex items-center gap-3 text-lg font-bold border', toast.type === 'success' ? 'bg-white/95 dark:bg-gray-800/95 text-green-600 border-green-500/30' : 'bg-white/95 dark:bg-gray-800/95 text-red-500 border-red-500/30']">
                    <i :class="['fas', toast.type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle', 'text-2xl']"></i>
                    <span>{{ toast.msg }}</span>
                </div>
            </div>
        </transition>

        <header class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md shadow-sm z-30 sticky top-0 border-b border-gray-100 dark:border-gray-700">
            <div class="container mx-auto px-4 h-16 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="/images/icon.png" alt="Logo" class="w-10 h-10 rounded-lg object-contain bg-gray-100 dark:bg-gray-700 p-1">
                    <span class="text-xl font-bold tracking-tight hidden md:block">ClashWeb</span>
                </div>
                <div class="flex items-center gap-4">
                    <button @click="openSettings" title="è®¾ç½®" class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition flex items-center justify-center text-gray-600 dark:text-gray-300 btn-soft">
                        <i class="fas fa-cog text-xl"></i>
                    </button>
                    <button @click="toggleTheme" class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition flex items-center justify-center text-yellow-500 btn-soft">
                        <i :class="isDark ? 'fas fa-moon' : 'fas fa-sun'" class="text-xl"></i>
                    </button>
                    <a href="https://github.com/nikoyomi/clashweb" target="_blank" class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition flex items-center justify-center text-gray-600 dark:text-gray-300 btn-soft">
                        <i class="fab fa-github text-xl"></i>
                    </a>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 py-8 max-w-5xl flex-1 flex flex-col gap-6 relative z-10">
            <div class="flex justify-between items-center w-full">
                <div class="flex gap-2 bg-gray-200/50 dark:bg-gray-800/50 p-1 rounded-xl overflow-x-auto no-scrollbar transition-colors">
                    <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
                        :class="['px-5 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap', currentTab === tab.id ? 'bg-white dark:bg-gray-700 shadow-sm text-primary' : 'text-gray-500 hover:text-gray-700 dark:hover:text-gray-300']">
                        <i :class="tab.icon" class="mr-2"></i> {{ tab.name }}
                    </button>
                </div>
                <button @click="restartContainers" title="é‡å¯å®¹å™¨" class="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-xl shadow-md transition-colors font-bold text-sm whitespace-nowrap ml-4 btn-soft">
                    <i class="fas fa-power-off"></i> é‡å¯ Clash
                </button>
            </div>

            <transition name="fade" mode="out-in">
                <div v-if="currentTab === 'home'" key="home" class="flex flex-col gap-6">
                    <div class="relative w-full h-80">
                        <transition name="switch" mode="out-in">
                            <div v-if="!configData.sub_url || showInputCard" key="input-card" class="absolute w-full h-full card-bg smooth-card p-8 border border-gray-100 dark:border-gray-700 text-center relative overflow-hidden flex flex-col justify-center">
                                <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-primary to-purple-600"></div>
                                <div v-if="configData.sub_url" class="absolute top-6 right-6 z-20 flex gap-2">
                                    <button @click="confirmClearSub" title="æ¸…ç©ºè®¢é˜…" class="w-10 h-10 rounded-xl bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 text-red-500 transition-colors flex items-center justify-center btn-soft">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                    <button @click="showInputCard = false" title="è¿”å›" class="w-10 h-10 rounded-xl bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-500 dark:text-gray-300 transition-colors flex items-center justify-center btn-soft">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="w-16 h-16 bg-indigo-50 dark:bg-indigo-900/40 text-primary rounded-2xl flex items-center justify-center mx-auto mb-4 text-2xl shadow-inner flex-shrink-0">
                                    <i class="fas fa-exchange-alt"></i>
                                </div>
                                <h2 class="text-xl font-bold text-center mb-5">{{ configData.sub_url ? 'æ›´æ¢è®¢é˜…' : 'åˆå§‹åŒ–è®¢é˜…' }}</h2>
                                <div class="max-w-xl w-full mx-auto flex flex-col gap-4 relative z-10">
                                    <div class="relative group">
                                        <i class="fas fa-link absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 group-focus-within:text-primary transition-colors"></i>
                                        <input v-model="form.sub_url" type="text" placeholder="åœ¨æ­¤ç²˜è´´æ–°æœºåœºè®¢é˜…é“¾æ¥..." class="w-full pl-10 pr-4 py-3.5 rounded-xl bg-white/70 dark:bg-gray-900/60 border-2 border-transparent focus:border-primary outline-none transition-all text-base shadow-inner">
                                    </div>
                                    <button @click="downloadConfig" class="w-full py-3.5 bg-green-600 hover:bg-green-700 text-white font-bold shadow-md transition-colors flex items-center justify-center gap-2 rounded-xl text-base btn-soft">
                                        <span>ä¸‹è½½å¹¶åº”ç”¨</span><i class="fas fa-bolt"></i>
                                    </button>
                                </div>
                            </div>

                            <div v-else key="info-card" class="absolute w-full h-full card-bg smooth-card p-8 border border-gray-100 dark:border-gray-700 relative overflow-hidden flex flex-col justify-center">
                                <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-primary to-purple-600"></div>
                                <div class="absolute top-6 right-6 z-20 flex gap-2">
                                    <button @click="confirmClearSub" title="æ¸…ç©ºè®¢é˜…" class="w-10 h-10 rounded-xl bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 text-red-500 transition-colors flex items-center justify-center btn-soft">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                    <button @click="showInputCard = true" title="åˆ‡æ¢/æ›´æ–°" class="w-10 h-10 rounded-xl bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-500 dark:text-gray-300 transition-colors flex items-center justify-center btn-soft">
                                        <i class="fas fa-exchange-alt"></i>
                                    </button>
                                </div>
                                <div class="flex items-center gap-5 mb-8 relative z-10">
                                    <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 text-white flex items-center justify-center text-3xl shadow-lg shadow-blue-500/30">
                                        <i class="fas fa-plane-departure"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <a :href="configData.user_info?.webUrl || 'javascript:void(0)'" :target="configData.user_info?.webUrl ? '_blank' : ''" :class="['text-3xl font-bold leading-tight truncate transition-colors flex items-center gap-2', configData.user_info?.webUrl ? 'text-gray-800 dark:text-white hover:text-primary cursor-pointer group' : 'text-gray-800 dark:text-white cursor-default']">
                                            {{ configData.user_info?.name || 'å½“å‰è®¢é˜…' }}
                                            <i v-if="configData.user_info?.webUrl" class="fas fa-external-link-alt text-sm opacity-0 group-hover:opacity-50 transition-opacity"></i>
                                        </a>
                                        <div class="text-sm text-gray-400 mt-1 flex items-center gap-2">
                                            <button @click="refreshSubscription" title="ç‚¹å‡»åˆ·æ–°" class="text-blue-500 hover:text-blue-600 dark:text-blue-400 transition-colors bg-blue-50 dark:bg-blue-900/20 rounded p-1 btn-soft">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                            <span class="font-mono">{{ configData.user_info?.update_time || analysis.update_time }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-3 w-full relative z-10">
                                    <div class="flex justify-between text-sm font-bold text-gray-600 dark:text-gray-300">
                                        <span>å·²ç”¨: <span class="text-gray-800 dark:text-white">{{ formatBytes((configData.user_info?.upload || 0) + (configData.user_info?.download || 0)) }}</span></span>
                                        <span>æ€»è®¡: <span class="text-gray-800 dark:text-white">{{ formatBytes(configData.user_info?.total || 0) }}</span></span>
                                    </div>
                                    <div class="w-full bg-gray-100 dark:bg-gray-900 rounded-full h-6 overflow-hidden shadow-inner border border-gray-200 dark:border-gray-600 relative">
                                        <div class="bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500 h-full rounded-full transition-all duration-1000 ease-out relative" :style="{ width: usagePercent + '%' }">
                                            <div class="absolute inset-0 bg-white/20 animate-[pulse_2s_infinite]"></div>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-center mt-2 text-xs font-medium text-gray-500 dark:text-gray-400">
                                        <div class="flex gap-4">
                                            <span class="flex items-center gap-1 bg-white/60 dark:bg-gray-800/60 px-2 py-1 rounded backdrop-blur-sm"><i class="fas fa-arrow-up text-green-500"></i> {{ formatBytes(configData.user_info?.upload || 0) }}</span>
                                            <span class="flex items-center gap-1 bg-white/60 dark:bg-gray-800/60 px-2 py-1 rounded backdrop-blur-sm"><i class="fas fa-arrow-down text-blue-500"></i> {{ formatBytes(configData.user_info?.download || 0) }}</span>
                                        </div>
                                        <div class="flex items-center gap-1 bg-orange-50 dark:bg-orange-900/20 text-orange-600 dark:text-orange-400 px-2 py-1 rounded"><i class="fas fa-hourglass-end"></i> {{ formatDate(configData.user_info?.expire || 0) }}</div>
                                    </div>
                                </div>
                            </div>
                        </transition>
                    </div>
                    <div class="flex flex-col gap-3">
                        <div class="flex flex-col gap-1 px-2">
                            <h3 class="text-lg font-bold flex items-center gap-2 text-gray-600 dark:text-gray-300"><i class="fas fa-map-marker-alt text-primary"></i> èŠ‚ç‚¹åˆ†å¸ƒ (å…± {{ analysis.total_nodes }} ä¸ª)</h3>
                            <div class="flex items-center gap-2 mt-1">
                                <div :class="['w-3 h-3 rounded-full transition-colors', configData.auto_update ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]' : 'bg-gray-300 dark:bg-gray-600']"></div>
                                <span v-if="configData.auto_update" class="text-xs font-medium text-green-600 dark:text-green-400">å·²è®¾ç½® {{ configData.cron_expression }} æ›´æ–°ä¸€æ¬¡</span>
                                <span v-else class="text-xs text-gray-400">æœªè®¾ç½®è‡ªåŠ¨æ›´æ–°è®¢é˜…</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                            <div v-for="region in analysis.regions" :key="region.name" class="region-card card-bg border border-transparent">
                                <div class="region-flag-bg">{{ region.icon }}</div>
                                <div class="relative z-10">
                                    <span class="text-lg font-bold text-gray-800 dark:text-gray-100 block">{{ region.name }}</span>
                                    <span class="text-sm font-medium text-primary bg-primary/10 px-2 py-0.5 rounded-full mt-1 inline-block">{{ region.count }} èŠ‚ç‚¹</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="currentTab === 'groups'" key="groups" class="flex flex-col gap-6">
                    <div class="card-bg smooth-card rounded-xl p-6 border-l-4 border-green-500 transition-colors">
                        <h3 class="text-lg font-bold mb-4 flex items-center gap-2">â• æ·»åŠ è‡ªå®šä¹‰ç»„</h3>
                        <div class="grid md:grid-cols-12 gap-6">
                            <div class="md:col-span-4 flex flex-col gap-4">
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">ç»„åç§°</label>
                                    <input v-model="groupInput.name" type="text" placeholder="ä¾‹å¦‚ï¼šæ¼ç½‘ä¹‹é±¼" class="w-full p-3 rounded-lg bg-white/70 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 outline-none focus:ring-2 focus:ring-green-500 text-lg transition-all">
                                </div>
                                <button @click="addNewGroup" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold shadow-md transition-colors flex items-center justify-center gap-2 rounded-xl btn-soft"><i class="fas fa-plus"></i> ç¡®è®¤æ·»åŠ </button>
                                <p class="text-xs text-gray-400 leading-relaxed">* æ–°ç»„å°†é»˜è®¤åŒ…å«æ‰€æœ‰èŠ‚ç‚¹ã€‚</p>
                            </div>
                            <div class="md:col-span-8">
                                <label class="block text-xs text-gray-500 mb-1">é€‰æ‹©å›¾æ ‡</label>
                                <div class="bg-white/70 dark:bg-gray-900/50 p-2 rounded-xl border dark:border-gray-700 h-40 overflow-y-auto grid grid-cols-10 gap-1 content-start custom-scrollbar">
                                    <button v-for="icon in icons" :key="icon" @click="insertIcon(icon)" class="aspect-square rounded hover:bg-white dark:hover:bg-gray-700 transition-colors flex items-center justify-center border border-transparent hover:border-gray-200 dark:hover:border-gray-600 text-lg cursor-pointer select-none">{{ icon }}</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-bg smooth-card rounded-xl p-6 flex-1 flex flex-col transition-colors">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold flex items-center gap-2">ğŸ“‚ ç­–ç•¥ç»„ç®¡ç† ({{ analysis.groups.length }})</h3>
                            <button @click="isGroupEditMode ? cancelGroupDelete() : toggleGroupEdit()" title="åˆ é™¤/å±è”½æ¨¡å¼" :class="isGroupEditMode ? 'bg-gray-400 text-white hover:bg-gray-500 shadow-md' : 'text-gray-500 bg-gray-100 dark:bg-gray-700 hover:text-red-500'" class="w-10 h-10 rounded-lg flex items-center justify-center transition-colors text-lg btn-soft">
                                <i :class="isGroupEditMode ? 'fas fa-times' : 'fas fa-trash-alt'"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            <div v-for="g in analysis.groups" :key="g.name" 
                                @click="isGroupEditMode && !['è‡ªåŠ¨é€‰æ‹©', 'èŠ‚ç‚¹é€‰æ‹©'].includes(g.name) ? toggleGroupSelection(g.name) : null"
                                :class="['p-4 rounded-xl border transition-colors relative cursor-pointer flex flex-col min-h-[90px] justify-between', 
                                    isGroupSelected(g.name) ? 'card-selected border-red-500' : 'bg-white/80 dark:bg-gray-700 border-transparent hover:border-gray-200 dark:hover:border-gray-600',
                                    isGroupEditMode && ['è‡ªåŠ¨é€‰æ‹©', 'èŠ‚ç‚¹é€‰æ‹©'].includes(g.name) ? 'opacity-50 cursor-not-allowed' : '']"> 
                                
                                <div class="flex justify-between items-start gap-2">
                                    <div class="font-medium truncate text-lg flex-1" :title="g.name">{{ g.name }}</div>
                                    <span v-if="g.source === 'native'" class="text-[10px] px-1.5 py-0.5 rounded badge-native whitespace-nowrap">â˜ï¸ åŸç”Ÿ</span>
                                    <span v-else class="text-[10px] px-1.5 py-0.5 rounded badge-custom whitespace-nowrap">ğŸ‘¤ è‡ªå®šä¹‰</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-2 flex items-center gap-1"><i class="fas fa-link"></i> {{ g.rule_count }} æ¡è§„åˆ™</div>
                                
                                <div v-if="isGroupEditMode" class="absolute top-2 right-2">
                                    <div :class="['w-5 h-5 rounded-full border flex items-center justify-center transition-colors', 
                                        isGroupSelected(g.name) ? 'bg-red-500 border-red-500 text-white' : 'border-gray-400 bg-white',
                                        ['è‡ªåŠ¨é€‰æ‹©', 'èŠ‚ç‚¹é€‰æ‹©'].includes(g.name) ? 'opacity-0' : '']"> 
                                        <i v-if="isGroupSelected(g.name)" class="fas fa-check text-xs"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-if="currentTab === 'rules'" key="rules" class="flex flex-col gap-6">
                    <div class="card-bg smooth-card rounded-xl p-6 border-l-4 border-green-500 transition-colors">
                        <h3 class="text-lg font-bold mb-1 flex items-center gap-2">â• æ·»åŠ è‡ªå®šä¹‰è§„åˆ™</h3>
                        <p class="text-xs text-gray-400 mb-4 ml-7">å¯æ‰¹é‡æ·»åŠ ï¼Œä¸€è¡Œä¸€ä¸ª</p>
                        <div class="grid md:grid-cols-12 gap-6">
                            <div class="md:col-span-8 flex flex-col gap-4">
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">è¾“å…¥å†…å®¹ (ç½‘å€/IP)</label>
                                    <textarea v-model="ruleInput.raw" rows="4" class="w-full p-3 rounded-lg bg-white/70 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 outline-none focus:ring-2 focus:ring-green-500 text-sm font-mono transition-all" placeholder="https://openai.com&#10;1.1.1.1"></textarea>
                                </div>
                                <button @click="addNewRules" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold shadow-md transition-colors flex items-center justify-center gap-2 rounded-xl btn-soft">
                                    <i class="fas fa-plus"></i> æ·»åŠ è§„åˆ™
                                </button>
                            </div>
                            <div class="md:col-span-4 flex flex-col gap-4 mt-1">
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">ç›®æ ‡ç­–ç•¥ç»„</label>
                                    <div class="relative">
                                        <select v-model="ruleInput.target" class="w-full p-3 rounded-lg bg-white/70 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 outline-none appearance-none text-sm transition-all">
                                            <option v-for="g in analysis.groups" :key="g.name" :value="g.name">{{ g.name }}</option>
                                        </select>
                                        <i class="fas fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">å¤‡æ³¨ <span class="text-gray-400 text-[10px]">(å¯é€‰)</span></label>
                                    <input v-model="ruleInput.remark" type="text" placeholder="ä¾‹å¦‚ï¼šChatGpt" class="w-full p-3 rounded-lg bg-white/70 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 outline-none focus:ring-2 focus:ring-green-500 text-sm transition-all">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-bg smooth-card rounded-xl p-6 flex-1 flex flex-col h-[600px] transition-colors">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold flex items-center gap-2">ğŸ“œ è§„åˆ™åˆ—è¡¨ ({{ analysis.rule_count }})</h3>
                            <div class="flex gap-2 items-center">
                                <input v-model="ruleSearch" type="text" placeholder="æœç´¢è§„åˆ™..." class="px-3 py-1 rounded bg-white/80 dark:bg-gray-700 text-sm border border-transparent focus:border-green-500 outline-none transition-all">
                                <button @click="isRuleEditMode ? cancelRuleDelete() : toggleRuleEdit()" title="åˆ é™¤/å±è”½æ¨¡å¼" :class="isRuleEditMode ? 'bg-gray-400 text-white hover:bg-gray-500 shadow-md' : 'text-gray-500 bg-gray-100 dark:bg-gray-700 hover:text-red-500'" class="w-10 h-10 rounded-lg flex items-center justify-center transition-colors text-lg btn-soft">
                                    <i :class="isRuleEditMode ? 'fas fa-times' : 'fas fa-trash-alt'"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex-1 overflow-y-auto bg-white/70 dark:bg-gray-900 rounded-lg border dark:border-gray-700 p-2 text-sm font-mono custom-scrollbar">
                            <div v-for="(item, idx) in filteredRules" :key="idx" @click="toggleRuleSelection(item)" :class="['p-2 border-b border-gray-200 dark:border-gray-800 flex items-center gap-3 cursor-pointer hover:bg-white/90 dark:hover:bg-gray-800 transition-colors', isRuleSelected(item) ? 'bg-red-50 dark:bg-red-900/20' : '']">
                                <div v-if="isRuleEditMode" :class="['w-4 h-4 rounded border flex-shrink-0 flex items-center justify-center', isRuleSelected(item) ? 'bg-red-500 border-red-500 text-white' : 'border-gray-400 bg-white']">
                                    <i v-if="isRuleSelected(item)" class="fas fa-check text-[10px]"></i>
                                </div>
                                <span class="text-gray-400 select-none w-8 text-right">{{ idx + 1 }}.</span>
                                <div class="truncate break-all flex-1 flex items-center gap-2">
                                    <span v-if="item.source === 'native'" class="text-[9px] px-1 py-0.5 rounded badge-native whitespace-nowrap">â˜ï¸</span>
                                    <span v-else class="text-[9px] px-1 py-0.5 rounded badge-custom whitespace-nowrap">ğŸ‘¤</span>
                                    <span class="">{{ item.str.split('#')[0] }}</span>
                                    <span v-if="item.str.includes('#')" class="text-gray-400 text-xs italic"># {{ item.str.split('#')[1] }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="currentTab === 'logs'" key="logs" class="flex flex-col gap-4 h-[700px]">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-bold"><i class="fas fa-terminal text-primary"></i> å®æ—¶æ—¥å¿—</h3>
                        <button @click="copyLogs" class="text-xs bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded hover:bg-gray-300 transition-colors">å¤åˆ¶æ—¥å¿—</button>
                    </div>
                    <div class="flex-1 bg-black text-green-400 font-mono text-xs md:text-sm p-4 rounded-xl overflow-y-auto border border-gray-700 shadow-inner terminal-logs custom-scrollbar" ref="logContainer">
                        <div v-if="logs.length === 0" class="text-gray-500 italic">æš‚æ— æ—¥å¿—æˆ–æ­£åœ¨åŠ è½½...</div>
                        <div v-for="(line, idx) in logs" :key="idx" class="whitespace-pre-wrap break-all hover:bg-gray-900">{{ line }}</div>
                    </div>
                </div>
            </transition>

            <div v-if="(isGroupEditMode && selectedGroups.length > 0) || (isRuleEditMode && selectedRules.length > 0)" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-8 py-4 rounded-full shadow-2xl z-50 flex items-center gap-4 transition-all hover:scale-105 cursor-pointer" @click="initiateDelete">
                <span class="font-bold text-lg">å·²é€‰ {{ isGroupEditMode ? selectedGroups.length : selectedRules.length }} é¡¹</span>
                <div class="h-6 w-[1px] bg-white/30"></div>
                <span class="font-bold flex items-center gap-2"><i class="fas fa-trash-alt"></i> æ‰§è¡Œæ“ä½œ</span>
            </div>
        </main>

        <div v-if="showSettings" class="fixed inset-0 bg-black/60 backdrop-blur-sm modal-mask flex items-center justify-center p-4" @click.self="showSettings = false">
            <div class="card-bg smooth-card w-full max-w-xl p-6 shadow-2xl overflow-hidden transform transition-all max-h-[90vh] overflow-y-auto flex flex-col modal-content">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold flex items-center gap-2"><i class="fas fa-sliders-h"></i> è®¾ç½®ä¸ç»´æŠ¤</h3>
                    <button @click="showSettings = false" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors"><i class="fas fa-times text-xl"></i></button>
                </div>

                <div class="flex gap-2 mb-6 p-1 bg-gray-100 dark:bg-gray-700/50 rounded-xl"> 
                    <button v-for="t in ['basic','history','backup']" :key="t" @click="settingsTab = t" 
                        :class="['flex-1 py-2 text-sm font-bold rounded-lg transition-all', settingsTab === t ? 'bg-white dark:bg-gray-600 shadow-sm text-primary' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700']">
                        {{ t === 'basic' ? 'åŸºç¡€è®¾ç½®' : (t === 'history' ? 'è®¢é˜…å†å²' : 'å¤‡ä»½è¿˜åŸ') }}
                    </button>
                </div>

                <div v-show="settingsTab === 'basic'" class="flex-1 space-y-5">
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-500">è½¬æ¢åç«¯ (Subconverter)</label>
                        <input v-model="configData.sub_backend" type="text" class="w-full p-3 rounded-lg bg-white/70 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 outline-none focus:ring-2 focus:ring-primary transition-all font-mono text-sm" placeholder="http://127.0.0.1:25500/">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-500">é‡å¯å®¹å™¨åç§° (é€—å·åˆ†éš”)</label>
                        <input v-model="configData.restart_containers" type="text" class="w-full p-3 rounded-lg bg-white/70 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 outline-none focus:ring-2 focus:ring-primary transition-all font-mono text-sm" placeholder="clash, yard">
                    </div>
                    <div class="p-4 bg-white/70 dark:bg-gray-700/30 rounded-xl border border-gray-100 dark:border-gray-600 flex flex-col gap-3">
                        <div class="flex items-center justify-between">
                            <label class="block text-sm font-bold text-gray-500 flex items-center gap-2"><i class="fas fa-clock"></i> å®šæ—¶è‡ªåŠ¨æ›´æ–°</label>
                            <div @click="configData.auto_update = !configData.auto_update" :class="['w-12 h-6 rounded-full p-1 cursor-pointer transition-colors', configData.auto_update ? 'bg-green-500' : 'bg-gray-300 dark:bg-gray-600']">
                                <div :class="['bg-white w-4 h-4 rounded-full shadow-md transform transition-transform duration-200', configData.auto_update ? 'translate-x-6' : 'translate-x-0']"></div>
                            </div>
                        </div>
                        <div v-if="configData.auto_update">
                            <input v-model="configData.cron_expression" type="text" class="w-full p-2 rounded bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 text-sm font-mono" placeholder="0 4 * * *">
                            <p class="text-xs text-gray-400 mt-1">Cron è¡¨è¾¾å¼ (ä¾‹: 0 4 * * * ä¸ºæ¯å¤©å‡Œæ™¨4ç‚¹)</p>
                        </div>
                    </div>
                </div>

                <div v-show="settingsTab === 'history'" class="flex-1 overflow-hidden flex flex-col h-64">
                    <div v-if="configData.sub_history && configData.sub_history.length > 0" class="space-y-3 overflow-y-auto pr-1 custom-scrollbar flex-1 pb-2">
                        <div v-for="(item, idx) in configData.sub_history" :key="idx" @click="applyHistory(item.url)" :class="['flex flex-col p-3 rounded-lg text-sm border transition-colors cursor-pointer group relative overflow-hidden', item.url === configData.sub_url ? 'bg-green-50 dark:bg-green-900/10 border-green-500/30 cursor-default' : 'bg-white/80 dark:bg-gray-700/50 border-transparent hover:border-primary/30']">
                            <div class="flex justify-between items-center mb-1 z-10">
                                <span class="font-bold text-gray-700 dark:text-gray-200 truncate pr-2">{{ item.name || 'æœªçŸ¥æœºåœº' }}</span>
                                <span v-if="item.url === configData.sub_url" class="text-green-500 text-xs font-bold whitespace-nowrap"><i class="fas fa-check"></i> ä½¿ç”¨ä¸­</span>
                                <span v-else class="text-xs text-gray-400 whitespace-nowrap">{{ item.date }}</span>
                            </div>
                            <div class="text-[10px] text-gray-400 font-mono truncate z-10 opacity-70">{{ item.url }}</div>
                        </div>
                    </div>
                    <div v-else class="text-center text-xs text-gray-400 py-10">æš‚æ— å†å²è®°å½•</div>
                </div>

                <div v-show="settingsTab === 'backup'" class="flex-1">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex flex-col gap-2">
                            <div @click="promptAndDownloadBackup" class="flex flex-col items-center justify-center p-6 rounded-xl bg-blue-50 dark:bg-blue-900/20 text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors border border-blue-200 dark:border-blue-800 cursor-pointer text-center group h-32">
                                <i class="fas fa-download text-3xl mb-2 group-hover:scale-110 transition-transform"></i><span class="font-bold text-sm">ä¸‹è½½é…ç½®å¤‡ä»½</span>
                            </div>
                            <p class="text-xs text-center text-gray-400">æ”¯æŒé€‰æ‹©æ˜¯å¦åŒ…å«æ•æ„Ÿè®¢é˜…ä¿¡æ¯</p>
                        </div>
                        <div class="flex flex-col gap-2">
                            <div class="relative flex flex-col items-center justify-center p-6 rounded-xl bg-orange-50 dark:bg-orange-900/20 text-orange-600 hover:bg-orange-100 dark:hover:bg-orange-900/40 transition-colors border border-orange-200 dark:border-orange-800 cursor-pointer text-center group h-32">
                                <input type="file" @change="restoreConfig" accept=".json" class="absolute inset-0 opacity-0 cursor-pointer z-10">
                                <i class="fas fa-upload text-3xl mb-2 group-hover:scale-110 transition-transform"></i><span class="font-bold text-sm">è¿˜åŸé…ç½®æ–‡ä»¶</span>
                            </div>
                            <p class="text-xs text-center text-gray-400">è‡ªåŠ¨æ™ºèƒ½åˆå¹¶è¿˜åŸ</p>
                        </div>
                    </div>
                </div>

                <div class="border-t border-gray-100 dark:border-gray-700 my-4 pt-4 flex justify-end gap-3">
                    <button @click="saveSettings" class="w-full py-3 bg-primary hover:bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-primary/20 transition-all btn-soft">ä¿å­˜å¹¶åº”ç”¨</button>
                </div>
            </div>
        </div>

        <div v-if="confirmModal.show" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[10000] flex items-center justify-center p-4">
            <div class="card-bg smooth-card w-full max-w-md p-6 shadow-2xl border-2 border-red-500/50">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-red-100 dark:bg-red-900/30 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl"><i class="fas fa-exclamation-triangle"></i></div>
                    <h3 class="text-xl font-bold mb-2">{{ confirmModal.title || 'æ“ä½œç¡®è®¤' }}</h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm" v-html="confirmModal.msg"></p>
                </div>
                <div class="flex gap-3">
                    <button @click="confirmModal.show = false" class="flex-1 py-3 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-xl font-bold transition-colors">å–æ¶ˆ</button>
                    <button @click="confirmModal.action" class="flex-1 py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold shadow-lg shadow-red-600/30 transition-colors">ç¡®è®¤</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, reactive, computed, onMounted, watch } = Vue

        createApp({
            setup() {
                const isDark = ref(true)
                const debounce = (fn, delay) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); }; };
                const globalLoading = ref(false), loadingText = ref('')
                const showSettings = ref(false), currentTab = ref('home'), settingsTab = ref('basic'), showInputCard = ref(false)
                const toast = reactive({ show: false, msg: '', type: 'success' })
                const confirmModal = reactive({ show: false, title: '', msg: '', action: null })
                const logs = ref([]), logContainer = ref(null); let logInterval = null
                const icons = ['ğŸš€', 'âœˆï¸', 'â˜ï¸', 'ğŸ”’', 'ğŸ›¡ï¸', 'ğŸ“¶', 'ğŸŒ', 'ğŸ ', 'ğŸ¢', 'ğŸ“º', 'ğŸ¬', 'ğŸµ', 'ğŸ®', 'ğŸ', 'ğŸ¤–', 'ğŸ™', 'ğŸ±', 'ğŸ¦„', 'ğŸ”¥', 'âš¡', 'ğŸ’¬', 'ğŸ›’', 'ğŸ’¾', 'ğŸ“¹', 'ğŸ“·', 'ğŸ“', 'ğŸ”', 'ğŸ›‘', 'âœ…', 'â™»ï¸', 'â™¾ï¸', 'ğŸ“¡', 'ğŸš¦', 'ğŸš¨', 'ğŸš§', 'ğŸ”§', 'ğŸ”¨', 'âš™ï¸', 'ğŸ’', 'ğŸ”‘', 'ğŸ””', 'ğŸ“¢', 'ğŸ¦ ', 'ğŸ§¬', 'ğŸ’Š', 'ğŸ’‰', 'ğŸ©¸', 'ğŸ”­', 'ğŸ”¬', 'ğŸŒ¡ï¸', 'ğŸ§ª', 'ğŸ§«', 'ğŸ§¬', 'ğŸ§¸', 'ğŸ', 'ğŸˆ', 'ğŸ‰', 'ğŸ¨', 'ğŸ­', 'ğŸª']
                const tabs = [{ id: 'home', name: 'ä»ªè¡¨ç›˜', icon: 'fas fa-tachometer-alt' }, { id: 'groups', name: 'ä»£ç†ç»„', icon: 'fas fa-layer-group' }, { id: 'rules', name: 'è§„åˆ™ç®¡ç†', icon: 'fas fa-list-ul' }, { id: 'logs', name: 'è¿è¡Œæ—¥å¿—', icon: 'fas fa-terminal' }]
                const form = reactive({ sub_url: '' })
                const configData = reactive({ sub_backend: '', sub_url: '', restart_containers: '', auto_update: false, cron_expression: '0 4 * * *', user_info: {}, sub_history: [], add_groups: [], del_groups: [], add_rules: [], del_rules: [] })
                const analysis = reactive({ groups: [], rules: [], rule_count: 0, regions: [], total_nodes: 0, update_time: '' })
                const groupInput = reactive({ name: '' }), isGroupEditMode = ref(false), selectedGroups = ref([])
                const ruleInput = reactive({ raw: '', target: '', remark: '' }), isRuleEditMode = ref(false), selectedRules = ref([]), ruleSearch = ref(''), searchKey = ref('')
                
                watch(ruleSearch, debounce((v) => searchKey.value = v, 300))

                const formatBytes = (bytes) => { if (!bytes) return '0 B'; const k = 1024, i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + ['B', 'KB', 'MB', 'GB', 'TB'][i]; }
                const formatDate = (ts) => (!ts) ? 'æ— é™æœŸ' : new Date(ts * 1000).toLocaleDateString()
                const usagePercent = computed(() => { if (!configData.user_info?.total) return 0; return Math.min(100, ((configData.user_info.upload + configData.user_info.download) / configData.user_info.total) * 100); })
                const showLoading = (t) => { loadingText.value = t; globalLoading.value = true }, hideLoading = () => globalLoading.value = false
                const showToast = (msg, type = 'success') => { toast.msg = msg; toast.type = type; toast.show = true; setTimeout(() => toast.show = false, 2500); }

                const loadData = async () => {
                    try {
                        const ts = new Date().getTime()
                        const [d, a] = await Promise.all([fetch('/api/data?t=' + ts).then(r => r.json()), fetch('/api/analysis?t=' + ts).then(r => r.json())])
                        Object.assign(configData, { user_info: {}, sub_history: [], add_groups: [], del_groups: [], add_rules: [], del_rules: [], ...d })
                        if (configData.sub_url) showInputCard.value = false; else showInputCard.value = true;
                        if (a.status === 'success') Object.assign(analysis, a)
                        if (analysis.groups.length > 0 && !ruleInput.target) ruleInput.target = analysis.groups[0].name
                    } catch (e) { console.error(e) }
                }

                const saveData = async () => { const res = await fetch('/api/data', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(configData) }); if (!res.ok) throw new Error("ä¿å­˜å¤±è´¥"); }
                
                // æ ¸å¿ƒé€»è¾‘ï¼šåŒºåˆ† Custom ä¸ Native çš„åˆ é™¤
                const initiateDelete = () => {
                    const count = isGroupEditMode.value ? selectedGroups.value.length : selectedRules.value.length;
                    if (count === 0) return;
                    
                    // æ„å»ºæç¤ºä¿¡æ¯
                    let msg = `å³å°†å¯¹ <b>${count}</b> é¡¹å†…å®¹æ‰§è¡Œåˆ é™¤æ“ä½œã€‚<br><br>`;
                    msg += `<span class="text-xs text-gray-400">æ³¨æ„ï¼š<br>â€¢ ğŸ‘¤ <b>è‡ªå®šä¹‰</b>é¡¹ç›®å°†è¢«å½»åº•ç§»é™¤ã€‚<br>â€¢ â˜ï¸ <b>åŸç”Ÿ</b>é¡¹ç›®å°†è¢«åŠ å…¥å±è”½åå•(éšè—)ã€‚</span>`;
                    
                    confirmModal.title = "æ‰¹é‡åˆ é™¤ç¡®è®¤";
                    confirmModal.msg = msg;
                    confirmModal.action = performDelete;
                    confirmModal.show = true;
                }

                const performDelete = async () => {
                    confirmModal.show = false; showLoading('æ­£åœ¨å¤„ç†...');
                    try {
                        if (isGroupEditMode.value) {
                            // éå†é€‰ä¸­çš„ç»„å¯¹è±¡ï¼ˆæ³¨æ„ï¼štoggleæ—¶å­˜çš„æ˜¯å®Œæ•´å¯¹è±¡æˆ–åç§°ï¼Œè¿™é‡Œå‡è®¾ç•Œé¢ä¼ çš„æ˜¯nameï¼Œéœ€è¦å»analysisé‡Œæ‰¾sourceï¼‰
                            for (const name of selectedGroups.value) {
                                const groupInfo = analysis.groups.find(g => g.name === name);
                                const isCustom = groupInfo && groupInfo.source === 'custom';
                                
                                if (isCustom) {
                                    // è‡ªå®šä¹‰ç»„ï¼šä» add_groups ç§»é™¤
                                    const idx = configData.add_groups.findIndex(g => g.name === name);
                                    if (idx > -1) configData.add_groups.splice(idx, 1);
                                    // é¡ºä¾¿ç§»é™¤è§„åˆ™ä¸­æŒ‡å‘è¯¥ç»„çš„
                                    configData.add_rules = configData.add_rules.filter(r => getRuleTarget(r) !== name);
                                } else {
                                    // åŸç”Ÿç»„ï¼šåŠ å…¥ del_groups
                                    if (!configData.del_groups.includes(name)) configData.del_groups.push(name);
                                }
                            }
                            selectedGroups.value = []; isGroupEditMode.value = false;
                        } else {
                            // åˆ é™¤è§„åˆ™
                            for (const ruleItem of selectedRules.value) {
                                // ruleItem ç»“æ„: { str: "...", source: "..." }
                                const cleanStr = ruleItem.str.split('#')[0].trim();
                                if (ruleItem.source === 'custom') {
                                    const idx = configData.add_rules.findIndex(r => r.split('#')[0].trim() === cleanStr);
                                    if (idx > -1) configData.add_rules.splice(idx, 1);
                                } else {
                                    if (!configData.del_rules.includes(cleanStr)) configData.del_rules.push(cleanStr);
                                }
                            }
                            selectedRules.value = []; isRuleEditMode.value = false;
                        }
                        await saveData(); 
                        // è§¦å‘ä¸€æ¬¡ä¸‹è½½ä»¥åº”ç”¨å˜æ›´ï¼ˆé‡æ–°ç”Ÿæˆyamlï¼‰
                        if(configData.sub_url) await fetch('/api/download', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url: configData.sub_url }) });
                        await loadData(); showToast('æ“ä½œæˆåŠŸ');
                    } catch (e) { showToast(e.message, 'error') } finally { hideLoading() }
                }

                const confirmClearSub = () => {
                    confirmModal.title = "âš ï¸ æ¸…ç©ºè®¢é˜…è­¦å‘Š";
                    confirmModal.msg = "ç¡®å®šè¦<b>æ¸…ç©ºå½“å‰è®¢é˜…</b>å¹¶é‡ç½®æ‰€æœ‰é…ç½®å—ï¼Ÿ<br>æ­¤æ“ä½œä¸å¯æ¢å¤ï¼ŒClash å°†åœæ­¢å·¥ä½œç›´åˆ°é‡æ–°é…ç½®ã€‚";
                    confirmModal.action = clearSubscription;
                    confirmModal.show = true;
                }

                const clearSubscription = async () => {
                    confirmModal.show = false; showLoading('æ­£åœ¨é‡ç½®...');
                    try {
                        const res = await fetch('/api/subscription', { method: 'DELETE' });
                        if (!res.ok) throw new Error("é‡ç½®å¤±è´¥");
                        await loadData();
                        showToast("è®¢é˜…å·²æ¸…ç©º");
                    } catch(e) { showToast(e.message, 'error') } finally { hideLoading() }
                }

                // å…¶ä»–é€»è¾‘ä¿æŒä¸å˜
                const fetchLogs = async () => { try { const res = await fetch('/api/logs?lines=200'); const d = await res.json(); logs.value = d.logs; if(logContainer.value) setTimeout(() => logContainer.value.scrollTop = logContainer.value.scrollHeight, 0) } catch {} }
                watch(currentTab, (v) => { if(v==='logs'){ fetchLogs(); logInterval=setInterval(fetchLogs, 5000) } else clearInterval(logInterval) })
                const copyLogs = () => navigator.clipboard.writeText(logs.value.join('\n')).then(()=>showToast('å·²å¤åˆ¶'))
                
                const getRuleTarget = (s) => { try { return s.split('#')[0].split(',')[2].trim() } catch { return '' } }
                const cleanRule = (s) => { 
                    if(!s.trim()) return null; 
                    // ç®€æ˜“æ­£åˆ™åˆ¤æ–­
                    if(s.includes(',')) return { type: 'RAW', value: s }; // ç”¨æˆ·å¯èƒ½ç›´æ¥è´´å®Œæ•´è§„åˆ™
                    // å¦åˆ™å°è¯•æ™ºèƒ½è¯†åˆ«åŸŸå/IP... (ç•¥ï¼Œä¿æŒåŸæœ‰é€»è¾‘)
                    return { type: 'DOMAIN-SUFFIX', value: s.trim() }; 
                }
                const addNewRules = async () => {
                    if(!ruleInput.raw || !ruleInput.target) return showToast("è¯·å¡«å†™å®Œæ•´", "error");
                    const lines = ruleInput.raw.split('\n');
                    for(let l of lines) {
                        if(!l.trim()) continue;
                        let r = l.trim();
                        // ç®€å•å¤„ç†ï¼šå¦‚æœç”¨æˆ·æ²¡å†™ç±»å‹ï¼Œé»˜è®¤DOMAIN-SUFFIXï¼Œå®é™…å»ºè®®ç”¨æ›´å¼ºæ­£åˆ™
                        if(!r.includes(',')) r = `DOMAIN-SUFFIX,${r},${ruleInput.target}`;
                        else {
                            // å¦‚æœç”¨æˆ·è´´äº†å®Œæ•´è§„åˆ™ä½†æ²¡æ”¹ç­–ç•¥ç»„ï¼Œå¼ºåˆ¶æ›¿æ¢ç­–ç•¥ç»„
                            let parts = r.split(',');
                            if(parts.length >= 2) r = `${parts[0]},${parts[1]},${ruleInput.target}`;
                        }
                        if(ruleInput.remark) r += ` # ${ruleInput.remark}`;
                        configData.add_rules.unshift(r);
                    }
                    await saveData(); await loadData(); ruleInput.raw=''; showToast("è§„åˆ™å·²æ·»åŠ ");
                }
                const addNewGroup = async () => {
                    if(!groupInput.name) return;
                    configData.add_groups.unshift({name: groupInput.name, type: 'select', proxies: ['DIRECT','REJECT']});
                    await saveData(); await loadData(); groupInput.name=''; showToast("ç»„å·²æ·»åŠ ");
                }
                
                const downloadConfig = async () => {
                    if(!configData.sub_backend) { showSettings.value=true; return showToast("è¯·å…ˆè®¾ç½®åç«¯","error"); }
                    if(!form.sub_url) return showToast("è¯·è¾“å…¥é“¾æ¥","error");
                    showLoading('æ›´æ–°ä¸­...');
                    try {
                        configData.sub_url = form.sub_url; // ç¡®ä¿ä¿å­˜çš„æ˜¯è¾“å…¥æ¡†çš„å€¼
                        await saveData();
                        const res = await fetch('/api/download', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({url:form.sub_url})});
                        if(!res.ok) throw new Error((await res.json()).detail);
                        await loadData(); showToast("æ›´æ–°æˆåŠŸ");
                    } catch(e){ showToast(e.message,'error') } finally { hideLoading() }
                }
                
                const restoreConfig = async (e) => {
                    if(!e.target.files[0]) return; showLoading('è¿˜åŸä¸­...');
                    const fd = new FormData(); fd.append('file', e.target.files[0]);
                    try {
                        const res = await fetch('/api/restore', {method:'POST', body:fd});
                        if(!res.ok) throw new Error("è¿˜åŸå¤±è´¥");
                        await loadData();
                        if(configData.sub_url) await fetch('/api/download', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({url:configData.sub_url})});
                        await loadData(); showToast("è¿˜åŸæˆåŠŸ"); showSettings.value=false;
                    } catch(err){ showToast(err.message,'error') } finally { hideLoading() }
                }
                
                const promptAndDownloadBackup = () => {
                    if(confirm("åŒ…å«è®¢é˜…é“¾æ¥å’Œå†å²è®°å½•å—ï¼Ÿ\nå–æ¶ˆåˆ™åªå¤‡ä»½è§„åˆ™é…ç½®ã€‚")) window.open('/api/backup?include_history=true');
                    else window.open('/api/backup?include_history=false');
                }

                // è¾…åŠ©
                const insertIcon = (i) => groupInput.name = i + ' ' + groupInput.name
                const toggleTheme = () => { isDark.value = !isDark.value; document.documentElement.classList.toggle('dark', isDark.value); localStorage.setItem('theme', isDark.value?'dark':'light'); }
                const applyHistory = (u) => { if(u === configData.sub_url) return; form.sub_url=u; downloadConfig(); }
                const restartContainers = async () => { showLoading('é‡å¯ä¸­...'); try { await fetch('/api/restart_containers',{method:'POST'}); showToast('å·²å‘é€é‡å¯å‘½ä»¤'); } catch(e){ showToast(e.message,'error') } finally { hideLoading() } }
                
                // é€‰æ‹©é€»è¾‘
                const cancelGroupDelete = () => { isGroupEditMode.value=false; selectedGroups.value=[] }
                const toggleGroupEdit = () => { isGroupEditMode.value=!isGroupEditMode.value; selectedGroups.value=[] }
                const isGroupSelected = (n) => selectedGroups.value.includes(n)
                const toggleGroupSelection = (n) => { 
                    // ä¿æŠ¤ç‰¹å®šç»„
                    if(['è‡ªåŠ¨é€‰æ‹©','èŠ‚ç‚¹é€‰æ‹©','GLOBAL','REJECT','DIRECT'].includes(n)) return;
                    isGroupSelected(n) ? selectedGroups.value.splice(selectedGroups.value.indexOf(n),1) : selectedGroups.value.push(n) 
                }
                const cancelRuleDelete = () => { isRuleEditMode.value=false; selectedRules.value=[] }
                const toggleRuleEdit = () => { isRuleEditMode.value=!isRuleEditMode.value; selectedRules.value=[] }
                const isRuleSelected = (r) => selectedRules.value.includes(r)
                const toggleRuleSelection = (r) => { isRuleSelected(r) ? selectedRules.value.splice(selectedRules.value.indexOf(r),1) : selectedRules.value.push(r) }
                
                const filteredRules = computed(() => {
                    if(!analysis.rules) return [];
                    const k = searchKey.value.toLowerCase();
                    let list = analysis.rules;
                    if(k) list = list.filter(r => r.str.toLowerCase().includes(k));
                    return list.slice(0, 100);
                })

                onMounted(() => { 
                    if(localStorage.getItem('theme') === 'light') { isDark.value=false; document.documentElement.classList.remove('dark'); }
                    loadData(); 
                })

                return {
                    isDark, toggleTheme, globalLoading, loadingText, showSettings, openSettings, currentTab, settingsTab, showInputCard, toast, confirmModal,
                    logs, copyLogs, logContainer, tabs, form, configData, analysis, icons, groupInput, ruleInput,
                    isGroupEditMode, toggleGroupEdit, isGroupSelected, toggleGroupSelection, selectedGroups, cancelGroupDelete,
                    isRuleEditMode, toggleRuleEdit, isRuleSelected, toggleRuleSelection, selectedRules, cancelRuleDelete,
                    ruleSearch, filteredRules, formatBytes, formatDate, usagePercent,
                    initiateDelete, performDelete, confirmClearSub, clearSubscription,
                    saveSettings: async () => { await saveData(); showSettings.value=false; showToast('è®¾ç½®å·²ä¿å­˜'); },
                    downloadConfig, restoreConfig, promptAndDownloadBackup, applyHistory, restartContainers, insertIcon, addNewRules, addNewGroup,
                    refreshSubscription: () => { form.sub_url = configData.sub_url; downloadConfig(); }
                }
            }
        }).mount('#app')
    </script>
</body>
</html>